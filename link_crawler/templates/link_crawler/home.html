{% extends "link_crawler/base.html" %}

{% block content%}

<div class="container mt-4">
    <!-- Filters Section -->
    <div class="row mb-5">
        <div class="col-md-8">
            <h4>Filters</h4>
            <form class="row g-3" method="get" action="{% url 'home' %}">
                <!-- Start Date Filter -->
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" value="{{ request.GET.startDate }}">
                </div>
                <!-- End Date Filter -->
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" value="{{ request.GET.endDate }}">
                </div>
                <!-- Link Type Filter -->
                <div class="col-md-3">
                    <label for="linkType" class="form-label">Link Type</label>
                    <select id="linkType" class="form-select" name="linkType">
                        <option value="Choose..." {% if request.GET.linkType == "" or not request.GET.linkType %}selected{% endif %}>Choose...</option>
                        <option value="Dofollow" {% if request.GET.linkType == "Dofollow" %}selected{% endif %}>Dofollow</option>
                        <option value="Nofollow" {% if request.GET.linkType == "Nofollow" %}selected{% endif %}>Nofollow</option>
                        <option value="Source Removed" {% if request.GET.linkType == "Source Removed" %}selected{% endif %}>Source Removed</option>
                        <option value="Link Removed" {% if request.GET.linkType == "Link Removed" %}selected{% endif %}>Link Removed</option>
                    </select>
                </div>
                <!-- Filter Button -->
                <div class="col-md-3 align-self-end">
                    <button type="submit" class="btn btn-info">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-2">
        <div class="col-md-7">
            <form method="get" action="{% url 'home' %}">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Enter target link to search" name="searchTargetLink" id="searchTargetLink" value="{{ request.GET.searchTargetLink }}">
                    <button class="btn btn-info ms-2" type="submit">Search</button>
                    <a href="/" class="btn btn-info ms-2">Refresh Results</a>
                </div>
            </form>
        </div>
    </div>    


<!-- Select and Table Section -->
<form id="select-form" method="post" action="">
    {% csrf_token %}
    <div class="row mb-3">
        <!-- Select Button aligned to the left -->
        <div class="col-md-6">
            <button type="button" class="toggle-select btn btn-info">Select</button>
        </div>
        <!-- Pagination and Rows per page dropdown aligned to the right -->
        <div class="col-md-6  d-flex justify-content-end">
            <!-- Pagination Previous Button -->
            {% if links.has_previous %}
                <a href="?page={{ links.previous_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="btn btn-outline-secondary me-2">
                    Previous
                </a>
            {% endif %}
    
            <!-- Rows per page dropdown -->
            <div class="btn-group d-inline-block">
                <label for="dropdownMenuButton" class="form-label">Rows per page:</label>
                <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ per_page }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="?page=1&per_page=20">20</a></li>
                    <li><a class="dropdown-item" href="?page=1&per_page=50">50</a></li>
                    <li><a class="dropdown-item" href="?page=1&per_page=100">100</a></li>
                    <li><a class="dropdown-item" href="?page=1&per_page=200">200</a></li>
                </ul>
            </div>
    
            <!-- Pagination Next Button -->
            {% if links.has_next %}
                <a href="?page={{ links.next_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="btn btn-outline-secondary ms-2">
                    Next
                </a>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col" class="checkbox-column" style="width: 50px;">#</th>
                        <th scope="col" style="width: 60px;">S.No</th>
                        <th scope="col">Target Link</th>
                        <th scope="col">Link To</th>
                        <th scope="col">Anchor Text</th>
                        <th scope="col" class="thin-column">Status of Link</th>
                        <th scope="col" class="thin-column">Link Created</th>
                        <th scope="col" class="thin-column">Last Crawled</th>
                    </tr>
                </thead>
                <tbody>
                    {% for link in links %}
                    <tr>
                        <td class="checkbox-column"><input type="checkbox" name="selected_links" value="{{ link.id }}"></td>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td title="{{ link.target_link }}">{{ link.target_link }}</td>
                        <td title="{{ link.link_to }}">{{ link.link_to }}</td>
                        <td>{{ link.anchor_text }}</td>
                        <td>
                            {% if link.get_status_of_link_display == "Dofollow" %}
                            <span class="status-dot dofollow"></span>Dofollow
                            {% elif link.get_status_of_link_display == "Nofollow" %}
                            <span class="status-dot nofollow"></span>Nofollow
                            {% elif link.get_status_of_link_display == "Source Removed" %}
                            <span class="status-icon">&#9760;</span>Source Removed
                            {% elif link.get_status_of_link_display == "Link Removed" %}
                            <span class="status-icon">&#x1F630;</span>Link Removed
                            {% else %}
                            Status Unknown
                            {% endif %}
                        </td>
                        <td>{{ link.link_created|date:"Y-m-d" }}</td>
                        <td>
                            {% if link.last_crawl_date %}
                            {{ link.last_crawl_date|date:"Y-m-d" }}
                            {% else %}
                            Not Crawled Yet
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="no-data">No links found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set initial state for checkbox columns to be hidden
        setInitialState();
    
        // Event listener for the Select button
        document.querySelector('.toggle-select').addEventListener('click', function() {
            toggleCheckboxes();
        });
    
        // Event listener for the per-page dropdown
        const perPageDropdown = document.getElementById('dropdownMenuButton');
        perPageDropdown.addEventListener('click', function (event) {
            if (event.target.tagName === 'A') {
                const newPerPage = event.target.textContent;
                const searchParams = new URLSearchParams(window.location.search);
                searchParams.set('per_page', newPerPage);
                searchParams.set('page', 1); // Reset to first page with new per_page
                window.location.search = searchParams.toString();
            }
        });
    });
    
    function setInitialState() {
        var elements = document.querySelectorAll('.checkbox-column');
        elements.forEach(function(el) {
            el.style.display = 'none'; // Hide the checkbox columns initially
        });
        // If there is any other element that needs to be hidden initially, add here.
    }
    
    function toggleCheckboxes() {
        var elements = document.querySelectorAll('.checkbox-column');
        // Determine the current display state based on the first element
        var currentState = elements[0].style.display === 'none' ? '' : 'none';
    
        // Apply the toggled state to all elements
        elements.forEach(function(el) {
            el.style.display = currentState;
        });
        // Toggle any other specific elements if needed
    }
</script>
    
{% endblock %}
    
    


