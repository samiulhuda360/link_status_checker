{% extends "link_crawler/base.html" %}

{% block content%}

<div class="container mt-4">
    <!-- Filters Section -->
    <div class="row mb-5">
        <div class="col-md-8">
            <h4>Filters</h4>
            <form class="row g-3" method="get" action="{% url 'home' %}">
                <!-- Start Date Filter -->
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" value="{{ request.GET.startDate }}">
                </div>
                <!-- End Date Filter -->
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" value="{{ request.GET.endDate }}">
                </div>
                <!-- Link Type Filter -->
                <div class="col-md-3">
                    <label for="linkType" class="form-label">Link Type</label>
                    <select id="linkType" class="form-select" name="linkType">
                        <option value="Choose..." {% if request.GET.linkType == "" or not request.GET.linkType %}selected{% endif %}>Choose...</option>
                        <option value="Dofollow" {% if request.GET.linkType == "Dofollow" %}selected{% endif %}>Dofollow</option>
                        <option value="Nofollow" {% if request.GET.linkType == "Nofollow" %}selected{% endif %}>Nofollow</option>
                        <option value="Source Removed" {% if request.GET.linkType == "Source Removed" %}selected{% endif %}>Source Removed</option>
                        <option value="Link Removed" {% if request.GET.linkType == "Link Removed" %}selected{% endif %}>Link Removed</option>
                    </select>
                </div>
                <!-- Filter Button -->
                <div class="col-md-3 align-self-end">
                    <button type="submit" class="btn btn-info">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-2">
        <div class="col-md-7">
            <form method="get" action="{% url 'home' %}">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Enter target link to search" name="searchTargetLink" id="searchTargetLink" value="{{ request.GET.searchTargetLink }}">
                    <button class="btn btn-info ms-2" type="submit">Search</button>
                    <a href="/" class="btn btn-info ms-2">Refresh Results</a>
                </div>
            </form>
        </div>
    </div>    


    <!-- Select and Table Section -->
    <form id="select-form" method="post" action="">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-3 align-self-end">
                <button type="button" class="toggle-select btn btn-info">Select</button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col" class="checkbox-column">#</th>
                            <th scope="col">S.No</th>
                            <th scope="col">Target Link</th>
                            <th scope="col">Link To</th>
                            <th scope="col">Anchor Text</th>
                            <th scope="col">Status of Link</th>
                            <th scope="col">Link Created</th>
                            <th scope="col">Last Crawled</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in links %}
                        <tr>
                            <td class="checkbox-column"><input type="checkbox" name="selected_links" value="{{ link.id }}"></td>
                            <th scope="row">{{ forloop.counter }}</th>
                            <td>{{ link.target_link }}</td>
                            <td>{{ link.link_to }}</td>
                            <td>{{ link.anchor_text }}</td>
                            <td>
                                {% if link.get_status_of_link_display == "Dofollow" %}
                                    <span class="status-dot dofollow"></span>Dofollow
                                {% elif link.get_status_of_link_display == "Nofollow" %}
                                    <span class="status-dot nofollow"></span>Nofollow
                                {% elif link.get_status_of_link_display == "Source Removed" %}
                                    <span class="status-icon">&#9760;</span>Source Removed <!-- Skull symbol -->
                                {% elif link.get_status_of_link_display == "Link Removed" %}
                                    <span class="status-icon">&#x1F630;</span>Link Removed <!-- Crying emoji -->
                                {% else %}
                                    Status Unknown
                                {% endif %}
                            </td>
                            <td>{{ link.link_created|date:"Y-m-d" }}</td>
                            <td>
                                {% if link.last_crawl_date %}
                                    {{ link.last_crawl_date|date:"Y-m-d" }}
                                {% else %}
                                    Not Crawled Yet
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9">No links found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row mb-3" id="submit-row" style="display: none;">
            <div class="col-md-4 align-self-end">
                <button type="submit" class="btn btn-primary">Marked As Addressed</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the state to match the CSS
        setInitialState();
    
        document.querySelector('.toggle-select').addEventListener('click', function() {
            // Select all elements with the 'checkbox-column' class
            var elements = document.querySelectorAll('.checkbox-column');
            // Determine the current display state based on the first element
            var currentState = elements[0].style.display === 'none' ? 'table-cell' : 'none';
            
            // Apply the toggled state to all elements
            elements.forEach(function(el) {
                if (el.tagName === 'TD' || el.tagName === 'TH') {
                    // Table cells and headers should toggle between 'table-cell' and 'none'
                    el.style.display = currentState;
                } else {
                    // Other elements (like the submit-row div) toggle between 'block' and 'none'
                    el.style.display = currentState === 'none' ? 'none' : 'block';
                }
            });
        });
    
        function setInitialState() {
            var elements = document.querySelectorAll('.checkbox-column');
            elements.forEach(function(el) {
                el.style.display = 'none'; // Explicitly set the initial state to 'none'
            });
            var submitRow = document.getElementById('submit-row');
            submitRow.style.display = 'none'; // Ensure the submit button row is also hidden initially
        }
    });
</script>
    
{% endblock %}
    
    


<!-- Correct Bootstrap Bundle with Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
